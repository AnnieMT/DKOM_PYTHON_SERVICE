# DKOM_PYTHON_SERVICE

## Prerequisites
----------------
### PYTHON BUILDPACK


For your local version you need to install the python buildpack which is available in github (https://github.wdf.sap.corp/xs2/sap_python_buildpack.git)

1. Connect to your workstation via commandline (putty)
2. Clone the repository https://github.wdf.sap.corp/xs2/sap_python_buildpack.git to your local machine (/tmp/sap_python_buildpack).
3. Enter the following command to install the buildpack: xs create-buildpack python_buildpack /tmp/sap_python_buildpack/ 3 --enable
4. Enter xs buildpacks to see if the installation was successfull

The first build of a python application will take some time because it will install all dependencies and store them into an temporary folder which will be available till reboot.

### Known problems
If you have some issues with the encoding of the env.sh file, delete your buildpack by entering xs delete-buildpack python_buildpack. 
Switch to your cloned git repository and find the env.sh file. Enter dos2unix <path-to-the-file>/env.sh to convert the encoding.
Install the buildpack again.

This should fix this issue.


## Additional setup
----------------
### Creating the cross schema access service
To access data outside the XSA container there is the need to create a user provided service that creates the bridge (technical explanation [here](https://blogs.sap.com/2016/07/03/xs-advanced-features-using-synonyms-using-non-hdi-container-schema-objects-in-hdi-container/) ). The schema name is to be on par with the one created for cloud foundry on DKOM. Replace where needed:

*xs cups CROSS_SCHEMA_ACCESS_SERVICE -p “{“host”:<hostname>”,“port”:"<hana port>",“user”:"<user_name>",
“password”:"<user_password>",“driver”:“com.sap.db.jdbc.Driver”,“tags”:[“hana”] , “schema”:“USR_4JS1EI5192ALIGS7L3SF9XC72” }"*

### Initial build.
On the initial state of the demo the file DB/src/procedures/get_rating.hdbprocedure has a part that represents the old SQL graph language. This version is not currently working so it needs to be commented out and replaced by the new one. The commented part starts after 
` -- using traditional SQL query: LIMITED NETWORK RADIUS!!! = 7 (biggest in our demo data) `
until
`------------------- REPLACE WITH THE NEW GRAPH SQL ----------------------------------------` The code snippet below this line needs to be uncommented.

This should enable the build of the whole project

After this build, the python service needs to be manually pushed into xs, since it is not natively supported. First on the command prompt type "xs s" and copy the full name of the HDI container created from the build. The name should be <user>-<container-id>-DKOM_PYTHON_SERVICE-hdi-container. 
On the web ide, replace the HDI container name on python/manifest.yml with the one in your machine. This will enable the python service to access your HDI container for the project. Then, export the python module, import it into your HANA machine and after unzipping it type "xs push".
After the push is successful the new app should be available for use.

---

## Instructions on functionality with Cloud Foundry and Accessing the data from outside the container.

The Schema name USR_4JS1EI5192ALIGS7L3SF9XC72  is used since this is the same schema name that was auto-generated by cloud foundry when we placed the table data there (users and transactions). For the sake of simplicity the schema is replicated with the same name on the local development environment to avoid build errors.

Cross schema access service for DKOM setup:
xs cups CROSS_SCHEMA_ACCESS_SERVICE -p '{"host":"hxehost","port":"39013","user":"XSA_ADMIN","password":"HXEHana1","driver":"com.sap.db.jdbc.Driver","tags":["hana"],"schema":"USR_4JS1EI5192ALIGS7L3SF9XC72"}'

Notes: 
-In case of errors during the first establishment of the service, use xs/cf uups to update the user provided service.
-If on build or deploy there is a ECONNREFUSED error it means the host/port are not properly set up, or the user doesn't have access to the database schema.


-------------------------------------------

After developing the service locally and building it, we can push it to the cloud foundry instance provided by Samir Zeort using cf deploy <mtar file>, 
everything is already set up on the cloud foundry instance to replicate the steps done above.

INSTANCE used:
org: DKOM2017
target: milano

Useful cloud foundry commands and applications (in case of help needed contact Samir Zeort):
#### Chisel
https://github.wdf.sap.corp/cloudfoundry/chisel
Chisel is useful to create a tunel between the users machine and the cloud foundry instance, this means that we can create a tunnel to the cloud foundry database, get a database user and create new database schemas for example.
This is already set up on cloud foundry, so in case of use, download the tool from github and then start the windows service on the binary folder with:
"chisel_windows_amd64.exe  client chisel-dkom2017.cfapps.sap.hana.ondemand.com --auth myuser:mysecret  localhost:30015:10.253.67.174:30041"

On hana studio, try to reach the cloud foundry with localhost:30015 and the username/password created in the bind service part of chisel setup



